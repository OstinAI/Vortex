<ResourceDictionary
    x:Class="Vortex.VortexStyles"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vortex="clr-namespace:Vortex">

    <vortex:FirstValueConverter x:Key="FirstValue"/>
    <vortex:NeonSideSimpleConverter x:Key="NeonSideSimpleConverter"/>
    <vortex:SkewAngleConverter x:Key="SkewAngleConverter"/>

    <Style x:Key="VortexNeonButton" TargetType="Button">

        <Setter Property="vortex:VortexButtonBehavior.Enable" Value="True"/>
        <Setter Property="Width" Value="144"/>
        <Setter Property="Height" Value="98"/>
        <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>

        <!-- ДОБАВЛЕНО: дефолты -->
        <Setter Property="vortex:ButtonProps.SkewDirection" Value="None"/>
        <Setter Property="vortex:ButtonProps.SkewAngle" Value="16"/>
        <Setter Property="vortex:ButtonProps.CornerRadius" Value="0"/>
        <Setter Property="vortex:ButtonProps.ShowContentPresenter" Value="False"/>

        <Setter Property="Template">
            <Setter.Value>

                <ControlTemplate TargetType="Button">

                    <!-- КОРНЕВОЙ GRID -->
                    <Grid x:Name="RootGrid"
                          RenderTransformOrigin="{Binding (vortex:ButtonProps.TransformOrigin),
                                                        RelativeSource={RelativeSource Mode=TemplatedParent}}">

                        <!-- ОСНОВНОЙ ТРАНСФОРМ (НАКЛОН ТУТ) -->
                        <Grid.RenderTransform>
                            <TransformGroup>
                                <ScaleTransform x:Name="scaleTransform" ScaleX="1" ScaleY="1"/>

                                <!-- RootSkew через Converter (SkewDirection + SkewAngle) -->
                                <SkewTransform x:Name="RootSkew">
                                    <SkewTransform.AngleX>
                                        <MultiBinding Converter="{StaticResource SkewAngleConverter}">
                                            <Binding RelativeSource="{RelativeSource TemplatedParent}"
                                                     Path="(vortex:ButtonProps.SkewDirection)"/>
                                            <Binding RelativeSource="{RelativeSource TemplatedParent}"
                                                     Path="(vortex:ButtonProps.SkewAngle)"/>
                                        </MultiBinding>
                                    </SkewTransform.AngleX>
                                </SkewTransform>

                                <RotateTransform Angle="0"/>
                                <TranslateTransform/>
                            </TransformGroup>
                        </Grid.RenderTransform>

                        <!-- ГРУППА ANIMATION STATES -->
                        <VisualStateManager.VisualStateGroups>
                            <VisualStateGroup x:Name="CommonStates">

                                <!-- NORMAL -->
                                <VisualState x:Name="Normal">
                                    <Storyboard>

                                        <DoubleAnimation Storyboard.TargetName="AnimatedOverlay"
                                                         Storyboard.TargetProperty="Opacity"
                                                         To="0"
                                                         Duration="0:0:0.3"/>

                                        <DoubleAnimation Storyboard.TargetName="GlowSpot"
                                                         Storyboard.TargetProperty="Opacity"
                                                         To="0" Duration="0:0:0.2"/>

                                        <DoubleAnimation Storyboard.TargetName="dropShadow"
                                                         Storyboard.TargetProperty="BlurRadius"
                                                         To="10" Duration="0:0:0.2"/>

                                        <ColorAnimation Storyboard.TargetName="dropShadow"
                                                        Storyboard.TargetProperty="Color"
                                                        To="Black" Duration="0:0:0.2"/>

                                        <DoubleAnimation Storyboard.TargetName="scaleTransform"
                                                         Storyboard.TargetProperty="ScaleX"
                                                         To="1" Duration="0:0:0.3"/>

                                        <DoubleAnimation Storyboard.TargetName="scaleTransform"
                                                         Storyboard.TargetProperty="ScaleY"
                                                         To="1" Duration="0:0:0.3"/>

                                        <DoubleAnimation Storyboard.TargetName="WavePulse"
                                                         Storyboard.TargetProperty="Opacity"
                                                         To="0" Duration="0:0:0.1"/>

                                        <DoubleAnimation Storyboard.TargetName="neonBorder"
                                                         Storyboard.TargetProperty="Opacity"
                                                         To="0" Duration="0:0:0.2"/>

                                    </Storyboard>
                                </VisualState>

                                <!-- MOUSE OVER -->
                                <VisualState x:Name="MouseOver">
                                    <Storyboard>

                                        <DoubleAnimation Storyboard.TargetName="AnimatedOverlay"
                                                         Storyboard.TargetProperty="Opacity"
                                                         To="0.5"
                                                         Duration="0:0:0.3"/>

                                        <DoubleAnimation Storyboard.TargetName="GlowSpot"
                                                         Storyboard.TargetProperty="Opacity"
                                                         To="1" Duration="0:0:0.15"/>

                                        <DoubleAnimation Storyboard.TargetName="dropShadow"
                                                         Storyboard.TargetProperty="BlurRadius"
                                                         To="120" Duration="0:0:0.2"/>

                                        <ColorAnimation Storyboard.TargetName="dropShadow"
                                                        Storyboard.TargetProperty="Color"
                                                        To="#E0FFFFFF" Duration="0:0:0.2"/>

                                        <DoubleAnimation Storyboard.TargetName="scaleTransform"
                                                         Storyboard.TargetProperty="ScaleX"
                                                         To="1.1" Duration="0:0:0.3"/>

                                        <DoubleAnimation Storyboard.TargetName="scaleTransform"
                                                         Storyboard.TargetProperty="ScaleY"
                                                         To="1.1" Duration="0:0:0.3"/>

                                        <DoubleAnimation Storyboard.TargetName="WavePulse"
                                                         Storyboard.TargetProperty="Opacity"
                                                         From="0.6" To="0"
                                                         Duration="1"
                                                         RepeatBehavior="Forever"/>

                                        <DoubleAnimation Storyboard.TargetName="WavePulse"
                                                         Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                                         From="1" To="4" Duration="1"
                                                         RepeatBehavior="Forever"/>

                                        <DoubleAnimation Storyboard.TargetName="WavePulse"
                                                         Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                                         From="1" To="4" Duration="1"
                                                         RepeatBehavior="Forever"/>

                                        <DoubleAnimation Storyboard.TargetName="neonBorder"
                                                         Storyboard.TargetProperty="Opacity"
                                                         To="1" Duration="0:0:0.15"/>

                                    </Storyboard>
                                </VisualState>

                                <!-- PRESSED -->
                                <VisualState x:Name="Pressed">
                                    <Storyboard>

                                        <DoubleAnimation Storyboard.TargetName="scaleTransform"
                                                         Storyboard.TargetProperty="ScaleX"
                                                         To="1" Duration="0:0:0.1"/>

                                        <DoubleAnimation Storyboard.TargetName="scaleTransform"
                                                         Storyboard.TargetProperty="ScaleY"
                                                         To="1" Duration="0:0:0.1"/>

                                    </Storyboard>
                                </VisualState>

                            </VisualStateGroup>
                        </VisualStateManager.VisualStateGroups>

                        <!-- BORDER (фон + тень) -->
                        <Border x:Name="MainBorder"
                                BorderThickness="0"
                                CornerRadius="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.CornerRadius)}">

                            <Border.Background>
                                <MultiBinding Converter="{StaticResource FirstValue}">
                                    <Binding Path="(vortex:ButtonProps.Background)"
                                             RelativeSource="{RelativeSource TemplatedParent}" />
                                    <Binding>
                                        <Binding.Source>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                <GradientStop Color="#0e2e47" Offset="0.4"/>
                                                <GradientStop Color="#2c5474" Offset="1"/>
                                            </LinearGradientBrush>
                                        </Binding.Source>
                                    </Binding>
                                </MultiBinding>
                            </Border.Background>

                            <Border.Effect>
                                <DropShadowEffect x:Name="dropShadow"
                                                  Color="Black"
                                                  BlurRadius="10"
                                                  ShadowDepth="0"
                                                  Opacity="1"/>
                            </Border.Effect>

                            <!-- CONTENT GRID -->
                            <Grid x:Name="contentGrid">

                                <Border x:Name="AnimatedOverlay"
                                        Background="#40FFFFFF"
                                        Opacity="0"
                                        IsHitTestVisible="False"
                                        Panel.ZIndex="0"
                                        CornerRadius="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.CornerRadius)}"/>

                                <!-- GIF -->
                                <Image x:Name="GifImage"
                                       Panel.ZIndex="1"
                                       Stretch="Uniform"
                                       Width="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.GifWidth)}"
                                       Height="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.GifHeight)}"
                                       Margin="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.GifMargin)}"
                                       RenderTransformOrigin="0.5,0.5"
                                       Source="{Binding RelativeSource={RelativeSource TemplatedParent},
                                                        Path=(vortex:ButtonProps.GifSource)}">

                                    <Image.RenderTransform>
                                        <TransformGroup>
                                            <ScaleTransform/>

                                            <!-- обратный наклон GIF -->
                                            <SkewTransform x:Name="GifUnskew">
                                                <SkewTransform.AngleX>
                                                    <MultiBinding Converter="{StaticResource SkewAngleConverter}" ConverterParameter="Invert">
                                                        <Binding RelativeSource="{RelativeSource TemplatedParent}"
                                                                 Path="(vortex:ButtonProps.SkewDirection)"/>
                                                        <Binding RelativeSource="{RelativeSource TemplatedParent}"
                                                                 Path="(vortex:ButtonProps.SkewAngle)"/>
                                                    </MultiBinding>
                                                </SkewTransform.AngleX>
                                            </SkewTransform>

                                            <TranslateTransform
                                                X="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.GifOffsetX)}"
                                                Y="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.GifOffsetY)}"/>
                                        </TransformGroup>
                                    </Image.RenderTransform>

                                    <Image.Style>
                                        <Style TargetType="Image">
                                            <Style.Triggers>

                                                <MultiDataTrigger>
                                                    <MultiDataTrigger.Conditions>
                                                        <Condition Binding="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.GifSource)}"
                                                                   Value=""/>
                                                    </MultiDataTrigger.Conditions>
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </MultiDataTrigger>

                                                <MultiDataTrigger>
                                                    <MultiDataTrigger.Conditions>
                                                        <Condition Binding="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.GifSource)}"
                                                                   Value="{x:Null}"/>
                                                    </MultiDataTrigger.Conditions>
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </MultiDataTrigger>

                                            </Style.Triggers>
                                        </Style>
                                    </Image.Style>

                                </Image>

                                <!-- ТЕКСТ -->
                                <TextBlock x:Name="VortexText"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           TextWrapping="Wrap"
                                           Panel.ZIndex="15">

                                    <TextBlock.RenderTransform>
                                        <!-- обратный наклон текста -->
                                        <SkewTransform x:Name="TextUnskew">
                                            <SkewTransform.AngleX>
                                                <MultiBinding Converter="{StaticResource SkewAngleConverter}" ConverterParameter="Invert">
                                                    <Binding RelativeSource="{RelativeSource TemplatedParent}"
                                                             Path="(vortex:ButtonProps.SkewDirection)"/>
                                                    <Binding RelativeSource="{RelativeSource TemplatedParent}"
                                                             Path="(vortex:ButtonProps.SkewAngle)"/>
                                                </MultiBinding>
                                            </SkewTransform.AngleX>
                                        </SkewTransform>
                                    </TextBlock.RenderTransform>

                                    <TextBlock.Text>
                                        <MultiBinding Converter="{StaticResource FirstValue}" FallbackValue="TEXT">
                                            <Binding Path="(vortex:ButtonProps.TextSource)"
                                                     RelativeSource="{RelativeSource TemplatedParent}"/>
                                            <Binding Path="Content"
                                                     RelativeSource="{RelativeSource TemplatedParent}"/>
                                        </MultiBinding>
                                    </TextBlock.Text>

                                    <TextBlock.FontSize>
                                        <MultiBinding Converter="{StaticResource FirstValue}" FallbackValue="18">
                                            <Binding Path="(vortex:ButtonProps.TextSize)"
                                                     RelativeSource="{RelativeSource TemplatedParent}"/>
                                            <Binding Path="FontSize"
                                                     RelativeSource="{RelativeSource TemplatedParent}"/>
                                        </MultiBinding>
                                    </TextBlock.FontSize>

                                    <TextBlock.Foreground>
                                        <MultiBinding Converter="{StaticResource FirstValue}" FallbackValue="White">
                                            <Binding Path="(vortex:ButtonProps.TextColor)"
                                                     RelativeSource="{RelativeSource TemplatedParent}"/>
                                            <Binding Path="Foreground"
                                                     RelativeSource="{RelativeSource TemplatedParent}"/>
                                        </MultiBinding>
                                    </TextBlock.Foreground>

                                    <TextBlock.Margin>
                                        <MultiBinding Converter="{StaticResource FirstValue}" FallbackValue="0">
                                            <Binding Path="(vortex:ButtonProps.TextMargin)"
                                                     RelativeSource="{RelativeSource TemplatedParent}"/>
                                            <Binding Path="Padding"
                                                     RelativeSource="{RelativeSource TemplatedParent}"/>
                                        </MultiBinding>
                                    </TextBlock.Margin>

                                </TextBlock>

                                <!-- НЕОНОВАЯ ЛИНИЯ (обтекает CornerRadius, ровная при CornerRadius=0) -->
                                <Border x:Name="neonBorder"
        Opacity="0"
        IsHitTestVisible="False"
        SnapsToDevicePixels="True"
        Panel.ZIndex="18"
        Background="Transparent"
        BorderBrush="#00FFFF"
        CornerRadius="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.CornerRadius)}">

                                    <Border.Effect>
                                        <DropShadowEffect Color="#00FFFF"
                          BlurRadius="22"
                          ShadowDepth="0"
                          Opacity="1"/>
                                    </Border.Effect>

                                    <Border.Style>
                                        <Style TargetType="Border">

                                            <!-- дефолт: снизу -->
                                            <Setter Property="HorizontalAlignment" Value="Stretch"/>
                                            <Setter Property="VerticalAlignment" Value="Stretch"/>
                                            <Setter Property="Width" Value="Auto"/>
                                            <Setter Property="Height" Value="Auto"/>
                                            <Setter Property="BorderThickness" Value="0,0,0,3"/>

                                            <Style.Triggers>

                                                <!-- СВЕРХУ -->
                                                <DataTrigger Binding="{Binding (vortex:ButtonProps.NeonSide),
                                       RelativeSource={RelativeSource TemplatedParent}}"
                             Value="{x:Static vortex:NeonSide.Top}">
                                                    <Setter Property="BorderThickness" Value="0,3,0,0"/>
                                                </DataTrigger>

                                                <!-- СЛЕВА -->
                                                <DataTrigger Binding="{Binding (vortex:ButtonProps.NeonSide),
                                       RelativeSource={RelativeSource TemplatedParent}}"
                             Value="{x:Static vortex:NeonSide.Left}">
                                                    <Setter Property="BorderThickness" Value="3,0,0,0"/>
                                                </DataTrigger>

                                                <!-- СПРАВА -->
                                                <DataTrigger Binding="{Binding (vortex:ButtonProps.NeonSide),
                                       RelativeSource={RelativeSource TemplatedParent}}"
                             Value="{x:Static vortex:NeonSide.Right}">
                                                    <Setter Property="BorderThickness" Value="0,0,3,0"/>
                                                </DataTrigger>

                                                <!-- СНИЗУ -->
                                                <DataTrigger Binding="{Binding (vortex:ButtonProps.NeonSide),
                                       RelativeSource={RelativeSource TemplatedParent}}"
                             Value="{x:Static vortex:NeonSide.Bottom}">
                                                    <Setter Property="BorderThickness" Value="0,0,0,3"/>
                                                </DataTrigger>

                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                </Border>


                                <!-- ЭФФЕКТЫ -->
                                <Grid x:Name="EffectClipper"
                                      ClipToBounds="True"
                                      Panel.ZIndex="20">

                                    <Canvas Panel.ZIndex="21">
                                        <Ellipse x:Name="WavePulse"
                                                 Width="20" Height="20"
                                                 Stroke="#80FFFFFF"
                                                 StrokeThickness="2"
                                                 Opacity="0"
                                                 RenderTransformOrigin="0.5,0.5">
                                            <Ellipse.RenderTransform>
                                                <ScaleTransform ScaleX="1" ScaleY="1"/>
                                            </Ellipse.RenderTransform>
                                        </Ellipse>
                                    </Canvas>

                                    <Canvas Panel.ZIndex="22">
                                        <Ellipse x:Name="GlowSpot"
                                                 Width="20" Height="20"
                                                 Fill="#80FFFFFF"
                                                 Opacity="0">
                                            <Ellipse.Effect>
                                                <BlurEffect Radius="15"/>
                                            </Ellipse.Effect>
                                        </Ellipse>
                                    </Canvas>

                                </Grid>

                                <!-- НЕОНОВЫЕ КРАЯ (оставлено как у тебя) -->
                                <Border x:Name="NeonTop"
                                        Height="3"
                                        VerticalAlignment="Top"
                                        Background="#00FFFF"
                                        Opacity="0"/>

                                <Border x:Name="NeonBottom"
                                        Height="3"
                                        VerticalAlignment="Bottom"
                                        Background="#00FFFF"
                                        Opacity="0"/>

                                <Border x:Name="NeonLeft"
                                        Width="3"
                                        HorizontalAlignment="Left"
                                        Background="#00FFFF"
                                        Opacity="0"/>

                                <Border x:Name="NeonRight"
                                        Width="3"
                                        HorizontalAlignment="Right"
                                        Background="#00FFFF"
                                        Opacity="0"/>

                                <!-- ContentPresenter -->
                                <ContentPresenter x:Name="contentPresenter"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"
                                                  Panel.ZIndex="10">
                                    <ContentPresenter.Style>
                                        <Style TargetType="ContentPresenter">
                                            <Setter Property="Visibility" Value="Collapsed"/>

                                            <Style.Triggers>

                                                <!-- если включили принудительно -->
                                                <DataTrigger Binding="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=(vortex:ButtonProps.ShowContentPresenter)}"
                                                             Value="True">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>

                                                <!-- но если Content пустой, снова скрываем -->
                                                <DataTrigger Binding="{Binding Content, RelativeSource={RelativeSource TemplatedParent}}"
                                                             Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>

                                            </Style.Triggers>
                                        </Style>
                                    </ContentPresenter.Style>
                                </ContentPresenter>

                            </Grid>

                        </Border>

                    </Grid>

                </ControlTemplate>

            </Setter.Value>
        </Setter>

    </Style>

</ResourceDictionary>
